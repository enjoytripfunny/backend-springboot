<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">


<mapper namespace="com.ssafy.enjoytrip.repository.MapRestoRepository">

	<!-- 맛지도 매핑 -->
	<resultMap type="mapRestoDto" id="mapResto">
		<result column="map_resto_no_pk" property="mapRestoNo"/>
		<result column="user_id_fk" property="userId"/>
		<result column="subject" property="subject"/>
		<result column="content" property="content"/>
		<result column="register_time" property="registerTime"/>
	</resultMap>
	
	<!-- 맛집 매핑 -->
	<resultMap type="restoDto" id="resto">
		<!-- <result column="resto_no" property="restoNo"/> -->
		<result column="resto_api_id" property="restoApiId"/>
		<result column="resto_name" property="restoName"/>
		<result column="resto_phone" property="restoPhone"/>
		<result column="category" property="category"/>
		<result column="address" property="address"/>
		<result column="latitude" property="latitude"/>
		<result column="longitude" property="longitude"/>
		<result column="like_count" property="likeCount"/>
		<result column="total_score" property="totalScore"/>
		<result column="save_count" property="saveCount"/>
	</resultMap> 
	
	<!-- 파일 매핑 -->
	<resultMap type="fileInfoDto" id="file">
		<result column="save_folder" property="saveFolder"/>
		<result column="original_file" property="originalFile"/>
		<result column="save_file" property="saveFile"/>
	</resultMap>

	<!-- 맛집 한개 등록(restaurant 테이블에 존재하지 않을 경우) -->
	<insert id="registerResto" parameterType="restoDto">
		insert into restaurant (resto_api_id, resto_name, resto_phone, category, address, latitude, longitude)
		values (#{restoApiId}, #{restoName},#{restoPhone},#{category},#{address},#{latitude},#{longitude})
		ON DUPLICATE KEY UPDATE save_count = save_count + 1;
	</insert>

	<!-- 맛집 여러개 등록(restaurant 테이블에 존재하지 않을 경우) -->
	<insert id="registerRestos" parameterType="restoDto">
		insert into restaurant (resto_api_id, resto_name, resto_phone, category, address, latitude, longitude)
		<foreach collection="restos" item="resto" separator=" , ">
			values (#{resto.restoApiId}, #{resto.restoName},#{resto.restoPhone},#{resto.category},#{resto.address},#{resto.latitude},#{resto.longitude})
		</foreach>
	</insert>
	
	<!-- 맛지도 등록(+파일) -->
	<insert id = "makeMapResto" parameterType="mapRestoDto">
		insert into map_restaurant (user_id_fk, subject, content)
		values (#{userId}, #{subject}, #{content})
		<selectKey resultType="int" keyProperty="mapRestoNo" order="AFTER">
			select last_insert_id()
		</selectKey>
	</insert>
	
	<!-- 맛지도 생성 시 파일 등록 -->
	<insert id="registerFile" parameterType="mapRestoDto">
		insert into file_info (map_resto_no_fk, save_folder, original_file, save_file)
		values (#{mapRestoNo}, #{saveFolder}, #{originalFile}, #{saveFile})
<!-- 		<foreach collection="fileInfos" item="fileinfo" separator=" , ">
			(#{articleNo}, #{fileinfo.saveFolder}, #{fileinfo.originalFile}, #{fileinfo.saveFile})
		</foreach> -->
	</insert>
	
	<!-- 맛지도 생성 시 맛집 등록 -->
	<insert id="registerUserResto" parameterType="mapRestoDto">
		insert into user_restaurant (map_resto_no_fk, resto_api_id_fk)
		<foreach collection="restos" item="resto" separator=" , ">
			(#{mapRestoNo}, #{resto.restoApiId})
		</foreach>
	</insert>
	
	<!-- 맛집 정보 가져오기 -->
	<select id="getResto" parameterType="string" resultType="string">
		select resto_api_id
		from restaurant 
		where resto_api_id = #{restoApiId}
	</select>
	
	<!-- 맛집 저장 개수 +1 -->
	<update id="updateSaveCount" parameterType="string">
		update restaurant
		set save_count = save_count + 1
		where resto_api_id = #{restoApiId}
	</update>
	
	<!-- 태그 등록 -->
	<insert id="registerTags" parameterType="mapRestoDto">
		insert into tags(map_resto_no_fk, tags)
		<foreach collection="tags" item="tag" separator=" , ">
			(#{mapRestoNo}, #{tag})
		</foreach>
	</insert>
	
	<!-- 맛지도리스트 가져오기 -->
	<select id="getMapRestosList" parameterType="map" resultMap="mapResto">
		select map_resto_no_pk, user_id_fk, subject, content, register_time 
		from map_restaurant
		limit #{start}, #{listsize}
	</select>

</mapper>