<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">


<mapper namespace="com.ssafy.enjoytrip.repository.MapRestoRepository">

	<!-- 맛지도 매핑 -->
	<resultMap type="mapRestoDto" id="mapResto">
		<result column="map_resto_no_pk" property="mapRestoNo"/>
		<result column="user_id_fk" property="userId"/>
		<result column="subject" property="subject"/>
		<result column="content" property="content"/>
		<result column="register_time" property="registerTime"/>
	</resultMap>
	
	<!-- 마이페이지 맛지도 목록 매핑 -->
	<resultMap type="mapRestoMypageDto" id="mapRestoMypage">
		<result column="map_resto_no_pk" property="mapRestoNo"/>
		<result column="user_id_fk" property="userId"/>
		<result column="subject" property="subject"/>
	</resultMap>
	
	
	<!-- 맛지도 목록 매핑 -->
	<resultMap type="mapRestoLikeDto" id="mapRestoLike">
		<result column="map_resto_no_pk" property="mapRestoNo"/>
		<result column="user_id_fk" property="userId"/>
		<result column="subject" property="subject"/>
		<result column="register_time" property="registerTime"/>
		<result column="like_value" property="likeValue"/>
	</resultMap>
	
	<!-- 맛집 매핑 -->
	<resultMap type="restoDto" id="resto">
		<!-- <result column="resto_no" property="restoNo"/> -->
		<result column="resto_api_id" property="restoApiId"/>
		<result column="resto_name" property="restoName"/>
		<result column="resto_phone" property="restoPhone"/>
		<result column="category" property="category"/>
		<result column="address" property="address"/>
		<result column="latitude" property="latitude"/>
		<result column="longitude" property="longitude"/>
<!-- 		<result column="like_count" property="likeCount"/>
		<result column="total_score" property="totalScore"/>
		<result column="save_count" property="saveCount"/> -->
	</resultMap> 
	
	<resultMap type="mapRestoDto" id="mapRestoFile">
		<result column="map_resto_no_pk" property="mapRestoNo"/>
		<result column="user_id_fk" property="userId"/>
		<result column="subject" property="subject"/>
		<result column="content" property="content"/>
		<result column="register_time" property="registerTime"/>
	  	<collection property="fileInfo" ofType="FileInfoDto">
    		<id property="mapRestoNo" column="mapRestoNo"/>
    		<result property="saveFolder" column="fileInfo_saveFolder"/>
    		<result property="originalFile" column="fileInfo_originalFile"/>
    		<result property="saveFile" column="fileInfo_saveFile"/>
  		</collection>
	</resultMap>
	
	<resultMap type="tagDto" id="tags">
		<result column="map_resto_no_pk" property="mapRestoNo"/>
		<result column="tag" property="tag"/>
	</resultMap>
	
	
<!-- 	
	<resultMap type="mapRestoDto" id="viewMapResto" extends="mapResto">
		<collection property="fileInfo" column="map_resto_no_pk" javaType="fileInfoDto"select="getFileInfo"/>
	</resultMap> -->
	
	<!-- 파일 매핑 -->
	<resultMap type="fileInfoDto" id="file">
		<result column="save_folder" property="saveFolder"/>
		<result column="original_file" property="originalFile"/>
		<result column="save_file" property="saveFile"/>
	</resultMap>

	<!-- 맛집 한개 등록 -->
	<insert id="registerResto" parameterType="restoDto">
		insert into restaurant (resto_api_id, resto_name, resto_phone, category, address, latitude, longitude)
		values (#{restoApiId}, #{restoName},#{restoPhone},#{category},#{address},#{latitude},#{longitude})
		ON DUPLICATE KEY UPDATE save_count = save_count + 1;
	</insert>

	<!-- 맛집 여러개 등록 -->
	<insert id="registerRestos" parameterType="mapRestoDto">
		insert into restaurant (resto_api_id, resto_name, resto_phone, category, address, latitude, longitude)
		<foreach collection="restos" item="resto" separator=" , ">
			values (#{resto.restoApiId}, #{resto.restoName},#{resto.restoPhone},#{resto.category},#{resto.address},#{resto.latitude},#{resto.longitude})
		</foreach>
	</insert>
	
	<!-- 맛지도 등록(+파일) -->
	<insert id = "makeMapResto" parameterType="mapRestoDto">
		insert into map_restaurant (user_id_fk, subject, content)
		values (#{userId}, #{subject}, #{content})
		<selectKey resultType="string" keyProperty="mapRestoNo" order="AFTER">
			select last_insert_id()
		</selectKey>
	</insert>
	
	<!-- 맛지도 생성 시 파일 등록 -->
	<insert id="registerFile" parameterType="mapRestoDto">
		insert into file_info (map_resto_no_fk, save_folder, original_file, save_file)
		values (#{mapRestoNo}, #{fileInfo.saveFolder}, #{fileInfo.originalFile}, #{fileInfo.saveFile})
	</insert>
	<insert id="registerFileTest" parameterType="FileInfoDto">
		insert into file_info (map_resto_no_fk, save_folder, original_file, save_file)
		values (18, #{saveFolder}, #{originalFile}, #{saveFile})
	</insert>
	
	<!-- 맛지도 생성 시 맛집 등록 -->
	<insert id="registerUserResto" parameterType="mapRestoDto">
		insert into user_restaurant (map_resto_no_fk, resto_api_id_fk)
		values
		<foreach collection="restos" item="resto" separator=" , ">
			(#{mapRestoNo}, #{resto.restoApiId})
		</foreach>
	</insert>
	
	<!-- 맛집 정보 가져오기 -->
	<select id="getResto" parameterType="string" resultType="string">
		select resto_api_id
		from restaurant 
		where resto_api_id = #{restoApiId}
	</select>
	
	<!-- 맛집 저장 개수 +1 -->
	<update id="updateSaveCount" parameterType="string">
		update restaurant
		set save_count = save_count + 1
		where resto_api_id = #{restoApiId}
	</update>
	
	<!-- 맛지도리스트 가져오기 -->
	<select id="getMapRestosList" parameterType="map" resultMap="mapResto">
		select map_resto_no_pk, user_id_fk, subject, content, register_time 
		from map_restaurant
		limit #{start}, #{listsize}
	</select>
	
	<!-- 맛지도 리스트와 좋아요까지 가져오기 -->
	<select id="getMapRestosLikeList" parameterType="mapRestoListParamDto" resultMap="mapRestoLike">
<!-- 		select mr.map_resto_no_pk, mr.user_id_fk, mr.subject, mr.register_time, li.like_value
		from map_restaurant mr
		left join like_info li
		on mr.map_resto_no_pk = li.map_resto_no_fk
		limit #{start}, #{listsize} -->
		select mr.map_resto_no_pk, mr.user_id_fk, mr.subject, mr.register_time,
		(select like_value from like_info where user_id_fk = #{userId} and mr.map_resto_no_pk = map_resto_no_fk) as like_value
		from map_restaurant mr
		limit 0, #{total}
	</select>
	
	<select id="getFileInfo" parameterType="string" resultMap="file">
		select save_folder, original_file, save_file
		from file_info
		where map_resto_no_fk = #{mapRestoNo}
	</select>
	
	<select parameterType="map" id="getMapRestoFileList" resultMap="mapRestoFile">
	SELECT
    mr.map_resto_no_pk AS mapRestoNo,
    mr.user_id_fk AS userId,
    mr.subject AS subject,
    mr.content AS content,
    mr.register_time AS registerTime,
    (SELECT save_folder, original_file, save_file
     FROM file_info fi
     WHERE fi.map_resto_no_fk = mr.map_resto_no_pk) AS fileInfo
	FROM map_resto mr
	limit #{start}, #{listsize}
	</select>
	
	<!-- 좋아요 누르기 -->
	<!-- 좋아요 테이블에 값 추가 -->
	<insert id="changeLike" parameterType="likeInfoDto">
		insert into like_info (user_id_fk, map_resto_no_fk, like_value)
		values (#{userId}, #{mapRestoNo},#{likeValue})
		ON DUPLICATE KEY UPDATE like_value = #{likeValue}
	</insert>
	<!-- 게시물의 좋아요 수 변경 -->
	
	<!-- 내가 작성한 맛지도 가져오기 -->
	<select id = "getMyMapResto" parameterType = "map" resultMap="mapRestoMypage">
		select map_resto_no_pk, user_id_fk, subject
		from map_restaurant
		where user_id_fk = #{userId}
		limit #{start}, #{listsize}
	</select>
	
	<!-- 내가 좋아요 누른 맛지도 가져오기 -->
	<select id = "getLikeMapResto" parameterType = "map" resultMap="mapRestoMypage">
		select map_resto_no_pk, mr.user_id_fk as user_id_fk, subject
		from map_restaurant mr
		join like_info li on mr.map_resto_no_pk = li.map_resto_no_fk
		where li.user_id_fk = #{userId} and li.like_value = 1
		limit #{start}, #{listsize}
	</select>
	
	<!-- 맛지도 상세 보기 -->
	<select id = "getDetailMapResto" parameterType = "string" resultMap = "mapResto">
	select map_resto_no_pk, user_id_fk, subject, content,register_time
	from map_restaurant
	where map_resto_no_pk = #{mapRestoNo}	
	</select>
	
	<!-- 맛지도 총개수 가져오기 -->
	<select id="getTotalMapResto" resultType="int">
		select count(*) 
		from map_restaurant
	</select>
	
	<!-- 태그 저장 -->
	<insert id="registerTags" parameterType = "mapRestoDto">
		insert into tags(map_resto_no_fk, tag) values
		<foreach collection="tags" item="tag" separator=" , ">
			(#{mapRestoNo}, #{tag})
		</foreach>
	</insert>
	
	<!-- 내가 작성한 맛지도 총개수 -->
	<select id="getTotalMyMapResto" resultType="int" parameterType="string">
		select count(*) 
		from map_restaurant
		where user_id_fk = #{userId}
	</select>
	
	<!-- 좋아요한 맛지도 총개수 -->
	<select id="getTotalLikeMapResto" resultType="int">
		select count(*)
		from map_restaurant mr
		join like_info li on mr.map_resto_no_pk = li.map_resto_no_fk
		where li.user_id_fk = #{userId} and li.like_value = 1
	</select>
	
	<!-- 맛지도에 등록된 식당들 가져오기 -->
	<select id="getUserRestoList" parameterType="string" resultMap="resto">
		select r.resto_api_id, r.resto_name, r.resto_phone, r.category, r.address, r.latitude, r.longitude
		from restaurant r
		join user_restaurant ur
		on r.resto_api_id = ur.resto_api_id_fk
		where ur.map_resto_no_fk = #{mapRestoNo}
	</select>

</mapper>